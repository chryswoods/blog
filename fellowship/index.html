
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Fellowship of the Ring &#8212; chryswoods blog</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="author" title="About these documents" href="../about/" />
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="The Two Towers" href="../two_towers/" />
    <link rel="prev" title="About the author" href="../about/" />
  
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
    <link rel="canonical" href="https://chryswoods.github.io/blogfellowship.html"/>
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../blog/atom.xml" title="The RSE">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="fellowship-of-the-ring">
<h1>Fellowship of the Ring<a class="headerlink" href="#fellowship-of-the-ring" title="Permalink to this headline">¶</a></h1>
<p>To set the scene, I must first say that I believe that software engineering
is a process that, at its heart, is designed to instill trust in software.
Trust is at the centre of everything that we do. It is so central,
and often-times implicit, that it is nearly always invisible and
under-valued. We only notice the importance of trust when it has gone.</p>
<p>Trust is critical to support data-based, evidence-led decision making.
Its success is based on an implicit ring of trust that binds
all of us together;</p>
<a class="reference internal image-reference" href="../_images/ring_of_trust.jpg"><img alt="Image showing the ring of trust described below" class="align-center" src="../_images/ring_of_trust.jpg" style="width: 400px;" /></a>
<div class="section" id="the-ring-of-trust">
<h2>The ring of trust<a class="headerlink" href="#the-ring-of-trust" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The public must trust that the government is making
sound decisions.</p></li>
<li><p>The government must trust that the researchers are making
sound recommendations.</p></li>
<li><p>The researchers must trust that the software they are
using is giving them sound predictions.</p></li>
<li><p>The software engineers must trust that the models produced by
the epidemiologists are fully described and will be able to
make good predictions.</p></li>
<li><p>The epidemiologists must trust that the data scientists
have given them sound data with which to develop their models.</p></li>
<li><p>The data scientists must trust that the data from
the public is accurate and up to date.</p></li>
</ul>
</div>
<div class="section" id="this-trust-runs-in-both-directions">
<h2>This trust runs in both directions!<a class="headerlink" href="#this-trust-runs-in-both-directions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The public must trust the epidemiologists to take proper
care of their private health and social data.</p></li>
<li><p>The government must trust the public to supply correct
data and to follow any rules and guidance.</p></li>
<li><p>The researchers must trust that the government will listen
to and accept their recommendations.</p></li>
<li><p>The software engineers must trust that the researchers will
use the software correctly and not over-interpret or
misrepresent any results.</p></li>
<li><p>The epidemiologists must trust the software engineers
to correctly translate their models and data into software.</p></li>
<li><p>The data scientists must trust the epidemiologists to
understand the data and recognise its limitations and inaccuracies.</p></li>
</ul>
</div>
<div class="section" id="how-trust-can-be-broken">
<h2>How trust can be broken<a class="headerlink" href="#how-trust-can-be-broken" title="Permalink to this headline">¶</a></h2>
<p>If any of these links weaken, then the ring of trust could break
down. If this happens, then public trust will be lost. This
would be disasterous, as the public would then
neither follow the rules and guidance from government,
nor supply their private data to the epidemiologists.</p>
<p>It is critically important that trust is maintained, and be
<em>seen to be maintained</em> at each of these links. Software and data
bind the ring of trust together, and so good data science
and good software engineering is vital.</p>
<p>While a blog post on the data science needs would be a great
read (e.g. how to clean data so it can be trusted, the need
for anonymisation and security, robust methods of collecting
data from the public etc.), it is not my domain of expertise.
I must therefore trust that the data scientists are doing their
work correctly and are writing blog posts accordingly.</p>
<p>I am a <a class="reference external" href="https://society-rse.org">Research Software Engineer</a>,
and so my role
is strengthening trust relating to the software. This
is how I was pulled into the
<a class="reference external" href="https://metawards.org">MetaWards</a> project. In so doing,
the last two weeks have taught me much about the vital role
of research software engineering, and how RSEs can make a
real difference.</p>
</div>
<div class="section" id="trust-in-software">
<h2>Trust in software<a class="headerlink" href="#trust-in-software" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/ldanon/metawards">MetaWards</a> is a
piece of software that is written by Leon Danon.
It predicts the spread of a disease via a stochastic metapopulation
model of the movements of people within and between electoral wards.</p>
<p>The program came from work conducted
<a class="reference external" href="https://doi.org/10.1016/j.epidem.2009.11.002">over 10 years ago</a>, and was
recently adapted to model CoVID-19 transmission in England and Wales,
with results published (pre-print) here;</p>
<ul class="simple">
<li><p><em>“A spatial model of CoVID-19 transmission in England and Wales:
early spread and peak timing”</em>, Leon Danon, Ellen Brooks-Pollock,
Mick Bailey, Matt J Keeling, medRxiv 2020.02.12.20022566; DOI:
<a class="reference external" href="https://doi.org/10.1101/2020.02.12.20022566">10.1101/2020.02.12.20022566</a></p></li>
</ul>
<p>These results were part of a suite of modelling that led to the
recommendation to enact a lock-down.</p>
<p>It is extremely important that predictions from this software, and
others like it, can be trusted to be correct. The
public have quite rightly asked that all software and data on which
policy is based is made available for scrutiny.
Any hints that a program is buggy or data is faulty
will lead to a loss of public and government trust in the
science. This means that the data sources, and this software and others like it,
will come under immense pressure to not only be correct, but also
<em>to be seen to be correct</em>.</p>
</div>
<div class="section" id="metawards-the-grey">
<h2>Metawards (the Grey)<a class="headerlink" href="#metawards-the-grey" title="Permalink to this headline">¶</a></h2>
<p>Leon published <a class="reference external" href="https://github.com/ldanon/MetaWards">MetaWards on GitHub</a>
on January 28th this year. A first, naive look at this code
would give the appearance that it is not well engineered.</p>
<p>The program is written in C, uses raw pointers everywhere, crashes
if it doesn’t get the expected input, and is configured by directly
editing the <em>main</em> function and recompiling. Input parameters and
source code are all mixed together, and testing appears to be
non-existant.</p>
<p>On this naive and incorrect first impression, MetaWards appears to
be a program that is not worthy of a lot of trust.</p>
<p>This naive view is incorrect because <em>MetaWards works</em>. It
correctly implements the
<a class="reference external" href="https://doi.org/10.1073/pnas.1000416107">model derived by Leon and his collaborators</a>.
Closer inspection of the code reveals lots of run-time testing. There
are many <em>if blocks</em> that check during the model run that the values being computed
make physical sense. The code layout is designed for speed and
flexibility. There simply wasn’t the research need or time to
build the <em>nice-to-haves</em> of a good user interface or visible
testing infrastructure.</p>
<p>The only thing “wrong” with the MetaWards C code is that it is now
being scaled up and put into production in a way that was
never envisioned when it was written. This image from my
<a class="reference external" href="https://drive.google.com/file/d/1qZC627mQVv9a-QQ2lv_H4ATsLh7qTG7m/view">bridges talk</a>
captures the problem well.</p>
<a class="reference internal image-reference" href="../_images/bridges.jpg"><img alt="Image of a rickety bridge representing research software." class="align-center" src="../_images/bridges.jpg" style="width: 95%;" /></a>
<p>Researchers are not trained software engineers. They are highly
intelligent people who know how to use the tools around them to solve
their research problems. They know how to write research software
that works and produces good results today. They are just not focussed
on or rewarded for writing software that will still work tomorrow.
Research software solutions
thus tend to be a little hacky,
<a class="reference external" href="https://www.wired.co.uk/article/heath-robinson-deserves-a-museum">Heath Robinson</a>
and bespoke. Normally this wouldn’t matter too much as the software is
invisible, and the research has moved on. However, anyone should be
wary of applying these solutions in production or at scale, as the leap
of faith needed to cross these bridges is very high.</p>
</div>
<div class="section" id="metawards-the-white">
<h2>MetaWards (the White)<a class="headerlink" href="#metawards-the-white" title="Permalink to this headline">¶</a></h2>
<p>To build trust, software must be engineered. It needs tests. It needs
needs documentation. It needs to be modular. It needs to be reproducible.
It needs to be version controlled. It needs to produce output complete
with provenance. It needs to scale. It needs to be easy for others to
download and to use, and to verify that it works. And all of these
things must be publicly visible so that, on a quick first impression,
the software <em>looks like it works</em>.</p>
<p>Transforming MetaWards from
<a class="reference external" href="https://github.com/ldanon/MetaWards">where it started</a> to
<a class="reference external" href="https://metawards.org">where it is now</a> was a long process
with many stages. This is why this is such a long multi-part blog post.</p>
<p>The first step to building trust was for me to gain trust
in the MetaWards code, and for Leon to gain trust in me as a research software
engineer.</p>
<p>I thus sat down with my laptop on Thursday morning with the
aim of learning exactly what MetaWards did and how it worked.
I needed to immerse myself in a Zen of Code, so that the entire
codebase was in my head. I needed deep understanding of
every line so that I could show Leon that I could
communicate with him in the language of his model and his code.</p>
</div>
<div class="section" id="translation-equals-understanding">
<h2>Translation equals understanding<a class="headerlink" href="#translation-equals-understanding" title="Permalink to this headline">¶</a></h2>
<p>Normally on such projects I would learn an algorithm or codebase by
translating key parts into another language. This is not to rewrite
the code. Rather, it forces me to fully read each line, and through translation,
I gain deep understanding.</p>
<p>In addition, I can instrument and add tests
to this translation, which enable me to play with the code in a familiar
environment, and which can then serve as stable reference points for
tests and experiments as I move forwards.</p>
<p>MetaWards is a
<a class="reference external" href="https://github.com/ldanon/MetaWards/blob/master/Model/wards_lib.c">relatively small code (~3000 lines)</a>, and so I estimated
that it wouldn’t take long to port all of it to Python. It took about
2.5 days (Thursday, Saturday afternoon and Sunday), at the end of which
I had a <a class="reference external" href="https://github.com/chryswoods/MetaWards/commit/f99041cd504da8674cd929cd35636bc10909568c">Python code</a>
that could reproduce, number-for-number, everything
that the original C code could do - albeit <em>significantly more slowly!</em></p>
<p>Creating this port surfaced a number of bugs. These were caught either
because Python has the concept of <em>None</em>, and so use-before-initialised
errors were caught, or because the act of translation itself raised logical
inconsistencies. For example, in one loop, the act of re-using
a distance calculated for two very similar data structures was incorrect,
as the actual ordering of the data in memory was different. No
automatic tool or skim read of code would have detected that problem.</p>
<p>The Python port gave me the flexibility to quickly refactor to fix those bugs.
I had pytest as a guard-rail, and could discover exactly how the
bugfixes changed, or didn’t change, the results compared to the
original C code. Fortunately, none of the bugs affected the central
predictions of MetaWards, meaning that I now have high confidence
that the code itself is <em>correct</em>. I was able to write a detailed
report to Leon with all my findings, together with detailed discussion
of the impacts of any code issues. This detailed feedback gave Leon
the trust he needed to allow me to continue working on his software.
This Python translation, together with my report, was good evidence
that convinced Leon that I could join the ring of trust.</p>
</div>
<div class="section" id="who-shall-pass">
<h2>Who shall pass?<a class="headerlink" href="#who-shall-pass" title="Permalink to this headline">¶</a></h2>
<p>With the translation completed I now had two versions of MetaWards.
Both appeared identical, reading the same inputs and writing the
same outputs. One was fast and powerful today. But the other had
the potential to be even faster and even more powerful tomorrow.
On Sunday evening I thus had a decision;</p>
<ul class="simple">
<li><p>work on fixing and developing the C code, which is fast, but would
be challenging to maintain and develop as part of a group, and
would accrue significant technical debt as it is developed which
would eventually need to be paid off,</p></li>
<li><p>or work on speeding up the Python code, which is easier to develop
and test, and which could be made into modular components that
could be repurposed for larger and more complex programs in the future.</p></li>
</ul>
<p>Whether via sound technical reasons, or post-decision rationalisation
of a moment of over-confidence and cockiness, I decided to press ahead
and speed up the Python code. I was emailing my report to Leon on
the Monday morning, and had a meeting with him on the Friday, and so
I had a little time to explore whether my Python could be as fast as C.
I set myself a deadline of the end of the week to achieve performance
parity with the C code. Suffice to say, by Friday morning I had enough
evidence to get Leon to trust that I wasn’t wasting time, and
<a class="reference external" href="https://github.com/metawards/MetaWards/commit/68de9c5e066d3b56d9018cd1d4648119b46181a9">by the evening</a>.
I had succeeded and the Python was faster than the C.</p>
</div>
<div class="section" id="what-s-next">
<h2>What’s next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="../two_towers">Part 2 - The Two Towers of Optimisation and Robustness</a></p>
</div>
</div>

  <div class="section">
  
  
  </div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../">The RSE</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/">About the author</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fellowship of the Ring</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-ring-of-trust">The ring of trust</a></li>
<li class="toctree-l2"><a class="reference internal" href="#this-trust-runs-in-both-directions">This trust runs in both directions!</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-trust-can-be-broken">How trust can be broken</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trust-in-software">Trust in software</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metawards-the-grey">Metawards (the Grey)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metawards-the-white">MetaWards (the White)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#translation-equals-understanding">Translation equals understanding</a></li>
<li class="toctree-l2"><a class="reference internal" href="#who-shall-pass">Who shall pass?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-s-next">What’s next?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../two_towers/">The Two Towers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../return_of_the_king/">Return of the King</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
      
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/fellowship.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>